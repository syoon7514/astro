import streamlit as st
import numpy as np
import matplotlib.pyplot as plt

# -----------------------------
# Streamlit UI êµ¬ì„±
# -----------------------------
st.title("ğŸŒŒ ì€í•˜ íšŒì „ ê³¡ì„  ì‹œë®¬ë ˆì´í„°")
st.markdown("""
ì´ ì‹œë®¬ë ˆì´í„°ëŠ” **ì€í•˜ì˜ íšŒì „ ê³¡ì„ **ì„ 21cm ìˆ˜ì†Œì„  ê´€ì¸¡ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‹œê°í™”í•˜ì—¬, **ì•”í‘ë¬¼ì§ˆì˜ ì¡´ì¬ ê°€ëŠ¥ì„±**ì„ íƒêµ¬í•©ë‹ˆë‹¤.
""")

# -----------------------------
# 1. ì‚¬ìš©ì ì…ë ¥: ë°˜ì§€ë¦„ë³„ ê´€ì¸¡ íŒŒì¥ or ì†ë„
# -----------------------------
st.header("ğŸ“¥ ë°˜ì§€ë¦„ë³„ ìˆ˜ì†Œì„  ê´€ì¸¡ê°’ ì…ë ¥")

with st.expander("ì…ë ¥ ì„¤ëª…"):
    st.markdown("""
    - ë°˜ì§€ë¦„: ì€í•˜ ì¤‘ì‹¬ì—ì„œì˜ ê±°ë¦¬ (kpc)
    - ê´€ì¸¡ íŒŒì¥ Î»<sub>obs</sub>: ê´€ì¸¡ëœ 21cm ìˆ˜ì†Œì„  íŒŒì¥ (ë‹¨ìœ„: cm)  
      â†’ ë„í”ŒëŸ¬ íš¨ê³¼ë¡œë¶€í„° ì†ë„ ê³„ì‚°ë¨  
    - ë˜ëŠ” ê³µì „ ì†ë„ (km/s)ë¥¼ ì§ì ‘ ì…ë ¥í•  ìˆ˜ë„ ìˆìŒ
    """)

# ê¸°ë³¸ ì…ë ¥ í…Œì´ë¸”
st.markdown("#### ë°˜ì§€ë¦„, ê´€ì¸¡ íŒŒì¥(ì˜µì…˜), ë˜ëŠ” ì†ë„ ì§ì ‘ ì…ë ¥")
sample_data = {
    "ë°˜ì§€ë¦„ (kpc)": [2, 4, 6, 8, 10, 12, 14, 16],
    "ê´€ì¸¡ íŒŒì¥ Î»_obs (cm)": [21.03, 21.05, 21.06, 21.08, 21.09, 21.10, 21.11, 21.12],
    "ì†ë„ (km/s, optional)": [None] * 8
}
data = st.data_editor(sample_data, num_rows="dynamic")

# ë„í”ŒëŸ¬ íš¨ê³¼ ê³„ì‚°
c = 3e5  # ë¹›ì˜ ì†ë„ km/s
Î»_0 = 21.0  # ìˆ˜ì†Œì„  ê¸°ì¤€ íŒŒì¥ (cm)

r_vals = []
v_obs = []

for row in data:
    r = row["ë°˜ì§€ë¦„ (kpc)"]
    Î» = row["ê´€ì¸¡ íŒŒì¥ Î»_obs (cm)"]
    v_direct = row["ì†ë„ (km/s, optional)"]

    if r is not None:
        r_vals.append(r)
        if v_direct is not None:
            v_obs.append(v_direct)
        else:
            # ë„í”ŒëŸ¬ ê³µì‹: v = c * (Î”Î» / Î»â‚€)
            delta_lambda = Î» - Î»_0
            v = c * (delta_lambda / Î»_0)
            v_obs.append(v)

r_vals = np.array(r_vals)
v_obs = np.array(v_obs)

# -----------------------------
# 2. ë‰´í„´ ì˜ˆì¸¡ ì†ë„ ê³„ì‚°
# -----------------------------
st.header("âš–ï¸ ë‰´í„´ ì—­í•™ ê¸°ë°˜ ì˜ˆì¸¡ ì†ë„")

mass_distribution = st.selectbox("ì¤‘ì‹¬ ì§ˆëŸ‰ ë¶„í¬ ê°€ì •", ["ê· ë“± êµ¬í˜• ì§ˆëŸ‰ ë¶„í¬ (M âˆ rÂ³)", "ì¤‘ì‹¬ ì§‘ì¤‘ ì§ˆëŸ‰ (M = const)"])

G = 4.3e-6  # ì¤‘ë ¥ ìƒìˆ˜ (kpc * (km/s)^2 / Msun)

if mass_distribution == "ê· ë“± êµ¬í˜• ì§ˆëŸ‰ ë¶„í¬ (M âˆ rÂ³)":
    M_r = r_vals ** 3
else:
    M_r = np.full_like(r_vals, r_vals[0] ** 3)

v_newton = np.sqrt(G * M_r / r_vals)

# -----------------------------
# 3. ì‹œê°í™”
# -----------------------------
st.header("ğŸ“ˆ íšŒì „ ê³¡ì„  ì‹œê°í™”")

fig, ax = plt.subplots()
ax.plot(r_vals, v_obs, 'o-', label="ê´€ì¸¡ ì†ë„ (21cm ìˆ˜ì†Œì„  ê¸°ë°˜)")
ax.plot(r_vals, v_newton, '--', label="ë‰´í„´ ì—­í•™ ì˜ˆì¸¡ ì†ë„")
ax.set_xlabel("ë°˜ì§€ë¦„ (kpc)")
ax.set_ylabel("ê³µì „ ì†ë„ (km/s)")
ax.set_title("ì€í•˜ íšŒì „ ê³¡ì„ : ê´€ì¸¡ vs ì˜ˆì¸¡")
ax.legend()
ax.grid(True)
st.pyplot(fig)

# -----------------------------
# 4. í•´ì„¤
# -----------------------------
st.header("ğŸ§  ê²°ê³¼ í•´ì„")
st.markdown(f"""
- **21cm ìˆ˜ì†Œì„  ê´€ì¸¡ê°’**ìœ¼ë¡œë¶€í„° ë„í”ŒëŸ¬ íš¨ê³¼ë¥¼ ì´ìš©í•´ ì†ë„ë¥¼ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.
- **ë‰´í„´ ì—­í•™ ì˜ˆì¸¡**ì— ë”°ë¥´ë©´ ì†ë„ëŠ” ë°˜ì§€ë¦„ì— ë”°ë¼ **ê°ì†Œ**í•´ì•¼ í•©ë‹ˆë‹¤.
- í•˜ì§€ë§Œ ì‹¤ì œ ê´€ì¸¡ ê²°ê³¼ëŠ” ì†ë„ê°€ ì¼ì •í•˜ê²Œ ìœ ì§€ë˜ì–´, ì€í•˜ ì™¸ê³½ì—ë„ ì§ˆëŸ‰ì´ ì¡´ì¬í•¨ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
- ì´ ì§ˆëŸ‰ì€ ìš°ë¦¬ê°€ ê´€ì¸¡í•  ìˆ˜ ì—†ëŠ” ë¬¼ì§ˆë¡œ, **ì•”í‘ë¬¼ì§ˆ(Dark Matter)**ì˜ ì¡´ì¬ë¥¼ ê°•í•˜ê²Œ ì‹œì‚¬í•©ë‹ˆë‹¤.
""")

