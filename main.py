import streamlit as st
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

# -----------------------------
# ê¸°ë³¸ ì„¤ì •
# -----------------------------
st.set_page_config(page_title="ì€í•˜ íšŒì „ ê³¡ì„  ì‹œë®¬ë ˆì´í„°", layout="centered")
st.title("ğŸŒŒ ì€í•˜ íšŒì „ ê³¡ì„  ì‹œë®¬ë ˆì´í„°")
st.markdown("""
ì´ ì‹œë®¬ë ˆì´í„°ëŠ” **21cm ìˆ˜ì†Œì„  ê´€ì¸¡ê°’**ì„ ë°”íƒ•ìœ¼ë¡œ **ë„í”ŒëŸ¬ íš¨ê³¼**ë¥¼ ì ìš©í•˜ì—¬ ì€í•˜ ë‚´ ë³„ë“¤ì˜ ê³µì „ ì†ë„ë¥¼ ê³„ì‚°í•˜ê³ ,  
ì´ë¥¼ **ë‰´í„´ ì—­í•™ ê¸°ë°˜ ì†ë„**ì™€ ë¹„êµí•˜ì—¬ **ì•”í‘ë¬¼ì§ˆì˜ ì¡´ì¬**ë¥¼ ì‹œê°ì ìœ¼ë¡œ íƒêµ¬í•©ë‹ˆë‹¤.
""")

# -----------------------------
# 1. ì‚¬ìš©ì ì…ë ¥: ê´€ì¸¡ ë°ì´í„° ì…ë ¥
# -----------------------------
st.header("ğŸ“¥ ë°˜ì§€ë¦„ë³„ ìˆ˜ì†Œì„  ê´€ì¸¡ê°’ ì…ë ¥")

sample_data = {
    "ë°˜ì§€ë¦„ (kpc)": [2, 4, 6, 8, 10, 12, 14, 16],
    "ê´€ì¸¡ íŒŒì¥ Î»_obs (cm)": [21.0001, 21.0002, 21.0003, 21.0004, 21.0005, 21.0006, 21.0007, 21.0008],
    "ì†ë„ (km/s, optional)": [None] * 8
}
data = st.data_editor(sample_data, num_rows="dynamic", use_container_width=True)

# -----------------------------
# 2. ë„í”ŒëŸ¬ íš¨ê³¼ ê³„ì‚°
# -----------------------------
c = 3e5  # ë¹›ì˜ ì†ë„ (km/s)
Î»_0 = 21.0  # ìˆ˜ì†Œì„  ê¸°ì¤€ íŒŒì¥ (cm)

r_vals = []
v_obs = []

for index, row in data.iterrows():
    r = row["ë°˜ì§€ë¦„ (kpc)"]
    Î» = row["ê´€ì¸¡ íŒŒì¥ Î»_obs (cm)"]
    v_direct = row["ì†ë„ (km/s, optional)"]

    if pd.notnull(r):
        r_vals.append(r)
        if pd.notnull(v_direct):
            v_obs.append(v_direct)
        else:
            if pd.notnull(Î»):
                delta_lambda = Î» - Î»_0
                v = c * (delta_lambda / Î»_0)
                v_obs.append(v)
            else:
                v_obs.append(0)  # ê¸°ë³¸ê°’

r_vals = np.array(r_vals)
v_obs = np.array(v_obs)

if len(r_vals) == 0:
    st.warning("ì…ë ¥ëœ ë°˜ì§€ë¦„ ê°’ì´ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    st.stop()

# -----------------------------
# 3. ë‰´í„´ ì˜ˆì¸¡ ì†ë„ ê³„ì‚°
# -----------------------------
st.header("âš–ï¸ ë‰´í„´ ì—­í•™ ê¸°ë°˜ ì˜ˆì¸¡ ì†ë„")

mass_distribution = st.selectbox("ì§ˆëŸ‰ ë¶„í¬ ê°€ì •", ["ê· ë“± êµ¬í˜• ë¶„í¬ (M âˆ rÂ³)", "ì¤‘ì‹¬ ì§‘ì¤‘ ì§ˆëŸ‰ (M = const)"])

G = 4.3e-6  # (kpc km^2 / s^2 Msun) â€” ì€í•˜ ë‹¨ìœ„ ì¤‘ë ¥ ìƒìˆ˜

if mass_distribution == "ê· ë“± êµ¬í˜• ë¶„í¬ (M âˆ rÂ³)":
    M_r = r_vals ** 3
else:
    M_r = np.full_like(r_vals, r_vals[0] ** 3)

v_newton = np.sqrt(G * M_r / r_vals)

# -----------------------------
# 4. ì‹œê°í™”
# -----------------------------
st.header("ğŸ“ˆ íšŒì „ ê³¡ì„  ì‹œê°í™”")

fig, ax = plt.subplots()
ax.plot(r_vals, v_obs, 'o-', label="ê´€ì¸¡ ì†ë„ (21cm ìˆ˜ì†Œì„  ê¸°ë°˜)", linewidth=2)
ax.plot(r_vals, v_newton, '--', label="ë‰´í„´ ì˜ˆì¸¡ ì†ë„", linewidth=2)
ax.set_xlabel("ë°˜ì§€ë¦„ (kpc)")
ax.set_ylabel("ê³µì „ ì†ë„ (km/s)")
ax.set_title("ì€í•˜ íšŒì „ ê³¡ì„ : ê´€ì¸¡ vs ì˜ˆì¸¡")
ax.grid(True)
ax.legend()
st.pyplot(fig)

# -----------------------------
# 5. ê²°ê³¼ í•´ì„¤
# -----------------------------
st.header("ğŸ§  ê²°ê³¼ í•´ì„¤")
st.markdown("""
- 21cm ìˆ˜ì†Œì„ ì˜ **ê´€ì¸¡ íŒŒì¥ Î»<sub>obs</sub>**ë¥¼ ì´ìš©í•´, ë„í”ŒëŸ¬ íš¨ê³¼ ê³µì‹ì„ ì ìš©í•˜ì—¬ **ì€í•˜ ë‚´ ë³„ì˜ ì†ë„**ë¥¼ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.
- **ë‰´í„´ ì—­í•™**ì— ë”°ë¥´ë©´ ì†ë„ëŠ” ì¤‘ì‹¬ì—ì„œ ë©€ì–´ì§ˆìˆ˜ë¡ **ê°ì†Œ**í•´ì•¼ í•©ë‹ˆë‹¤. (ì§ˆëŸ‰ì´ ëŒ€ë¶€ë¶„ ì¤‘ì‹¬ì— ìˆì„ ê²½ìš°)
- í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ì†ë„ê°€ ì¼ì •í•˜ê²Œ ìœ ì§€ë˜ëŠ” íŒ¨í„´ì„ ë³´ì´ë©°, ì´ëŠ” **ê´€ì¸¡ë˜ì§€ ì•ŠëŠ” ì§ˆëŸ‰(ì•”í‘ë¬¼ì§ˆ)**ì´ ë¶„í¬í•˜ê³  ìˆìŒì„ ì‹œì‚¬í•©ë‹ˆë‹¤.
- ì´ì™€ ê°™ì€ íšŒì „ ê³¡ì„ ì€ ì€í•˜ ë°”ê¹¥ê¹Œì§€ ì•”í‘ë¬¼ì§ˆì´ í¼ì ¸ ìˆìŒì„ ë³´ì—¬ì£¼ëŠ” **ê°•ë ¥í•œ ìš°ì£¼ë¡ ì  ì¦ê±°**ì…ë‹ˆë‹¤.
""", unsafe_allow_html=True)

